{% extends "base.html" %}

{% block title %}EPF Calculator - Calculate Your Provident Fund Maturity{% endblock %}

{% block content %}
<style>
/* Custom Slider Styles */
.slider-orange {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    cursor: pointer;
    height: 8px;
    border-radius: 4px;
    outline: none;
}

/* WebKit browsers (Chrome, Safari, Opera) */
.slider-orange::-webkit-slider-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 4px;
    border: none;
}

.slider-orange::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background: #f97316;
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    margin-top: -8px;
}

/* Firefox */
.slider-orange::-moz-range-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 4px;
    border: none;
}

.slider-orange::-moz-range-thumb {
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background: #f97316;
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    border: none;
}

.slider-orange::-moz-range-progress {
    background: #f97316;
    height: 8px;
    border-radius: 4px;
}

/* Internet Explorer */
.slider-orange::-ms-track {
    background: transparent;
    border-color: transparent;
    border-width: 8px 0;
    color: transparent;
    height: 8px;
}

.slider-orange::-ms-fill-lower {
    background: #f97316;
    border-radius: 4px;
}

.slider-orange::-ms-fill-upper {
    background: #e5e7eb;
    border-radius: 4px;
}

.slider-orange::-ms-thumb {
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background: #f97316;
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    margin-top: 1px;
}

/* Result Cards */
.result-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #f3f4f6;
    text-align: center;
}

.result-value {
    font-size: 2rem;
    font-weight: 700;
    margin-top: 8px;
    line-height: 1.2;
}

.result-label {
    font-size: 0.95rem;
    color: #6b7280;
    font-weight: 500;
    margin-bottom: 4px;
}

/* Input styling */
.input-container {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-width: 140px;
}

.input-value {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
    background: transparent;
    border: none;
    outline: none;
    text-align: right;
    width: 100%;
}

.input-unit {
    color: #64748b;
    font-size: 0.875rem;
    margin-left: 8px;
    font-weight: 500;
}

/* Toggle buttons */
.toggle-container {
    background: #e2e8f0;
    border-radius: 8px;
    padding: 4px;
    display: flex;
}

.toggle-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    background: transparent;
}

.toggle-btn.active {
    background: #f97316;
    color: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.toggle-btn:not(.active) {
    color: #64748b;
}

/* Chart container */
.chart-container {
    position: relative;
    height: 250px;
    margin: 20px 0;
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    .result-value {
        font-size: 1.75rem;
    }
}
</style>

<!-- Calculator Header -->
<section class="bg-white py-6 shadow-sm">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">EPF Calculator</h1>
        <p class="text-center text-gray-600">Calculate your Employees' Provident Fund maturity amount</p>
    </div>
</section>

<div class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            
            <!-- Main Grid Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                
                <!-- Left Column - Input Controls -->
                <div class="space-y-8">
                    
                    <!-- Monthly Salary Slider -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-lg font-medium text-gray-700">Monthly Salary (Basic + DA)</label>
                            <div class="input-container">
                                <span class="input-unit">â‚¹</span>
                                <input type="number" id="monthly_salary_input" value="50000" 
                                       class="input-value" min="10000" max="500000" step="5000">
                            </div>
                        </div>
                        <div class="relative">
                            <input type="range" id="monthly_salary" min="10000" max="500000" value="50000" step="5000"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-orange">
                            <div class="flex justify-between text-sm text-gray-500 mt-3">
                                <span>0</span>
                                <span>1L</span>
                                <span>2L</span>
                                <span>3L</span>
                                <span>4L</span>
                                <span>5L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Interest Rate Slider -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-lg font-medium text-gray-700">Interest Rate</label>
                            <div class="input-container">
                                <input type="number" id="interest_rate_input" value="8.25" step="0.25"
                                       class="input-value" min="5" max="15">
                                <span class="input-unit">%</span>
                            </div>
                        </div>
                        <div class="relative">
                            <input type="range" id="interest_rate" min="5" max="15" value="8.25" step="0.25"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-orange">
                            <div class="flex justify-between text-sm text-gray-500 mt-3">
                                <span>5%</span>
                                <span>7.5%</span>
                                <span>10%</span>
                                <span>12.5%</span>
                                <span>15%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Years to Retirement Slider -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-lg font-medium text-gray-700">Years to Retirement</label>
                            <div class="flex items-center space-x-3">
                                <div class="input-container">
                                    <input type="number" id="years_input" value="30" 
                                           class="input-value" min="5" max="40">
                                    <span class="input-unit" id="years_unit">Yr</span>
                                </div>
                                <div class="toggle-container">
                                    <button type="button" id="tenure-yr-btn" class="toggle-btn active">Yr</button>
                                    <button type="button" id="tenure-mo-btn" class="toggle-btn">Mo</button>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <input type="range" id="years_to_retirement" min="5" max="40" value="30" step="1"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-orange">
                            <div class="flex justify-between text-sm text-gray-500 mt-3" id="years_labels">
                                <span>5</span>
                                <span>15</span>
                                <span>25</span>
                                <span>35</span>
                                <span>40</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Controls Row -->
                    <div class="grid grid-cols-2 gap-6">
                        
                        <!-- Current Age -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Current Age</label>
                            <div class="input-container">
                                <input type="number" id="current_age" value="30" 
                                       class="input-value" min="18" max="58" readonly>
                                <span class="input-unit">Years</span>
                            </div>
                        </div>
                        
                        <!-- Annual Salary Increase -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Annual Increase</label>
                            <div class="input-container">
                                <input type="number" id="annual_increase" value="5" step="0.5"
                                       class="input-value" min="0" max="15">
                                <span class="input-unit">%</span>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- EPF Contribution -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">EPF Contribution Rate</label>
                        <div class="input-container">
                            <input type="number" id="epf_contribution_rate" value="24" step="1"
                                   class="input-value" min="12" max="36">
                            <span class="input-unit">%</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Employee (12%) + Employer (12%) = 24%</p>
                    </div>
                    
                </div>
                
                <!-- Right Column - Results -->
                <div class="space-y-6">
                    
                    <!-- Main Results -->
                    <div class="space-y-4">
                        
                        <!-- Final EPF Amount -->
                        <div class="result-card">
                            <div class="result-label">Final EPF Amount</div>
                            <div class="result-value text-gray-800" id="final-epf-amount">â‚¹ 28,63,818</div>
                        </div>
                        
                        <!-- Total Interest -->
                        <div class="result-card">
                            <div class="result-label">Total Interest Earned</div>
                            <div class="result-value text-gray-800" id="total-interest">â‚¹ 1,90,70,995</div>
                        </div>
                        
                        <!-- Total Payment -->
                        <div class="result-card">
                            <div class="result-label">Total Payment<br/>(Principal + Interest)</div>
                            <div class="result-value text-gray-800" id="total-payment">â‚¹ 2,86,38,187</div>
                        </div>
                        
                    </div>
                    
                    <!-- Breakdown Chart -->
                    <div class="result-card">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Break-up of Total Payment</h3>
                        <div class="chart-container">
                            <canvas id="epf-breakdown-chart"></canvas>
                        </div>
                        
                        <!-- Chart Legend -->
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="flex items-center justify-center">
                                <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                                <div class="text-center">
                                    <div class="text-sm font-medium text-gray-700">Total Contribution</div>
                                    <div class="text-sm text-gray-500" id="contribution-percentage">46.3%</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-center">
                                <div class="w-4 h-4 bg-orange-500 rounded-full mr-2"></div>
                                <div class="text-center">
                                    <div class="text-sm font-medium text-gray-700">Total Interest</div>
                                    <div class="text-sm text-gray-500" id="interest-percentage">53.7%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
            </div>
            
            <!-- Interactive Bar Chart Section -->
            <div class="mt-12">
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800">Schedule showing EPF payments starting from</h3>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <input type="month" id="startMonth" value="2025-01" 
                                           class="px-3 py-1 text-sm border border-gray-300 rounded-md bg-white">
                                    <button class="p-1 text-gray-400 hover:text-gray-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                </div>
                                <select id="viewType" class="px-3 py-1 text-sm border border-gray-300 rounded-md bg-white">
                                    <option value="yearly">Calendar Year-wise</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bar Chart Container -->
                    <div class="p-6">
                        <div class="relative bg-gray-50 rounded-lg p-6" style="height: 500px;">
                            <!-- Chart Canvas -->
                            <canvas id="epf-bar-chart" class="w-full h-full"></canvas>
                        </div>
                        
                        <!-- Chart Legend -->
                        <div class="flex justify-center items-center space-x-8 mt-6">
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-green-500 rounded-sm"></div>
                                <span class="text-sm font-medium text-gray-600">Principal</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-orange-500 rounded-sm"></div>
                                <span class="text-sm font-medium text-gray-600">Interest</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-sm font-medium text-gray-600">Balance</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EMI-Style Year-wise Breakdown Table -->
            <div class="mt-12">
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                    <!-- Table Container -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-3 text-left font-bold text-gray-800 border-r border-gray-300 bg-gray-200">Year</th>
                                    <th class="px-4 py-3 text-center font-bold text-white border-r border-green-600 bg-green-500">
                                        Principal<br><span class="font-normal text-xs">(A)</span>
                                    </th>
                                    <th class="px-4 py-3 text-center font-bold text-white border-r border-orange-600 bg-orange-500">
                                        Interest<br><span class="font-normal text-xs">(B)</span>
                                    </th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-800 border-r border-gray-300 bg-gray-200">
                                        Total Payment<br><span class="font-normal text-xs">(A + B)</span>
                                    </th>
                                    <th class="px-4 py-3 text-center font-bold text-white border-r border-pink-600 bg-pink-600">Balance</th>
                                    <th class="px-4 py-3 text-center font-bold text-gray-800 bg-gray-200">
                                        EPF Accumulated<br><span class="font-normal text-xs">To Date</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="epf-breakdown-table" class="bg-white">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Download/Share Section -->
                    <div class="px-6 py-6 bg-gray-50 border-t border-gray-200">
                        <div class="text-center">
                            <p class="text-gray-700 font-medium mb-4">
                                Want to download OR share a custom link to your EPF calculation (with all your numbers pre-filled)?
                            </p>
                            <div class="flex justify-center space-x-4">
                                <button onclick="downloadPDF()" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download PDF
                                </button>
                                <button onclick="downloadExcel()" class="inline-flex items-center px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download Excel
                                </button>
                                <button onclick="shareCalculation()" class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                    </svg>
                                    Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script>
let epfChart = null;
let isMonthMode = false;

// Format currency for display
function formatCurrency(amount) {
    if (amount >= 10000000) {
        return 'â‚¹ ' + (amount / 10000000).toFixed(2).replace(/\.00$/, '') + ' Cr';
    } else if (amount >= 100000) {
        return 'â‚¹ ' + (amount / 100000).toFixed(2).replace(/\.00$/, '') + ' L';
    } else if (amount >= 1000) {
        return 'â‚¹ ' + (amount / 1000).toFixed(0) + ' K';
    } else {
        return 'â‚¹ ' + Math.round(amount).toLocaleString('en-IN');
    }
}

function formatFullCurrency(amount) {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// Calculate EPF
function calculateEPF() {
    const monthlySalary = parseFloat(document.getElementById('monthly_salary').value);
    const interestRate = parseFloat(document.getElementById('interest_rate').value) / 100;
    const yearsValue = parseFloat(document.getElementById('years_to_retirement').value);
    const yearsToRetirement = isMonthMode ? yearsValue / 12 : yearsValue;
    const annualIncrease = parseFloat(document.getElementById('annual_increase').value) / 100;
    const epfContribution = parseFloat(document.getElementById('epf_contribution_rate').value) / 100;
    
    // Update current age
    const retirementAge = 60;
    const currentAge = Math.round(retirementAge - yearsToRetirement);
    document.getElementById('current_age').value = currentAge;
    
    let currentSalary = monthlySalary;
    let epfBalance = 0;
    let totalContribution = 0;
    let totalInterest = 0;
    let yearlyData = [];
    
    const years = Math.ceil(yearsToRetirement);
    
    for (let year = 1; year <= years; year++) {
        const yearlyContribution = currentSalary * 12 * epfContribution;
        const interestEarned = epfBalance * interestRate;
        
        epfBalance += yearlyContribution + interestEarned;
        totalContribution += yearlyContribution;
        totalInterest += interestEarned;
        
        yearlyData.push({
            year: year,
            age: currentAge + year,
            contribution: yearlyContribution,
            interest: interestEarned,
            balance: epfBalance
        });
        
        currentSalary *= (1 + annualIncrease);
    }
    
    const finalAmount = epfBalance;
    const totalPayment = totalContribution + totalInterest;
    
    // Update display
    document.getElementById('final-epf-amount').textContent = formatCurrency(finalAmount);
    document.getElementById('total-interest').textContent = formatCurrency(totalInterest);
    document.getElementById('total-payment').textContent = formatCurrency(totalPayment);
    
    // Update percentages
    const contributionPercentage = ((totalContribution / totalPayment) * 100).toFixed(1);
    const interestPercentage = ((totalInterest / totalPayment) * 100).toFixed(1);
    
    document.getElementById('contribution-percentage').textContent = contributionPercentage + '%';
    document.getElementById('interest-percentage').textContent = interestPercentage + '%';
    
    // Update chart
    updateChart(totalContribution, totalInterest);
    
    // Update bar chart
    updateBarChart(yearlyData);
    
    // Update table
    updateTable(yearlyData);
}

// Update pie chart
function updateChart(contribution, interest) {
    const ctx = document.getElementById('epf-breakdown-chart').getContext('2d');
    
    if (epfChart) {
        epfChart.destroy();
    }
    
    const total = contribution + interest;
    
    epfChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [contribution, interest],
                backgroundColor: ['#22c55e', '#f97316'],
                borderWidth: 0,
                cutout: '65%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataIndex === 0 ? 'Total Contribution' : 'Total Interest';
                            const value = context.parsed;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + formatFullCurrency(value) + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// Bar Chart Variables
let epfBarChart = null;

// Update bar chart (EMI-style)
function updateBarChart(yearlyData) {
    const ctx = document.getElementById('epf-bar-chart').getContext('2d');
    
    if (epfBarChart) {
        epfBarChart.destroy();
    }
    
    // Prepare data for chart
    const labels = yearlyData.map(data => (new Date().getFullYear() + data.year - 1).toString());
    const contributions = yearlyData.map(data => data.contribution);
    const interests = yearlyData.map(data => data.interest);
    const balances = yearlyData.map(data => data.balance);
    
    // Find max values for scaling
    const maxBalance = Math.max(...balances);
    const maxAnnual = Math.max(...contributions.concat(interests));
    
    epfBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Principal',
                    data: contributions,
                    backgroundColor: '#22c55e',
                    borderColor: '#16a34a',
                    borderWidth: 1,
                    borderRadius: 2,
                    yAxisID: 'y1'
                },
                {
                    label: 'Interest',
                    data: interests,
                    backgroundColor: '#f97316',
                    borderColor: '#ea580c',
                    borderWidth: 1,
                    borderRadius: 2,
                    yAxisID: 'y1'
                },
                {
                    label: 'Balance',
                    data: balances,
                    type: 'line',
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: '#dc2626',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#374151',
                    borderWidth: 1,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    callbacks: {
                        title: function(context) {
                            return 'Year ' + context[0].label;
                        },
                        label: function(context) {
                            const label = context.dataset.label;
                            const value = context.parsed.y;
                            return label + ': ' + formatFullCurrency(value);
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#6b7280',
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: false
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#6b7280',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            if (value >= 10000000) {
                                return 'â‚¹ ' + (value / 10000000).toFixed(1) + 'Cr';
                            } else if (value >= 100000) {
                                return 'â‚¹ ' + (value / 100000).toFixed(0) + 'L';
                            } else if (value >= 1000) {
                                return 'â‚¹ ' + (value / 1000).toFixed(0) + 'K';
                            }
                            return 'â‚¹ ' + value.toLocaleString('en-IN');
                        }
                    },
                    title: {
                        display: true,
                        text: 'Balance',
                        color: '#374151',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    stacked: true,
                    grid: {
                        drawOnChartArea: false,
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        color: '#6b7280',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            if (value >= 100000) {
                                return 'â‚¹ ' + (value / 100000).toFixed(0) + 'L';
                            } else if (value >= 1000) {
                                return 'â‚¹ ' + (value / 1000).toFixed(0) + 'K';
                            }
                            return 'â‚¹ ' + value.toLocaleString('en-IN');
                        }
                    },
                    title: {
                        display: true,
                        text: 'EPF Payment / Yr',
                        color: '#374151',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    });
}

// Update table (EMI-style)
function updateTable(yearlyData) {
    const tableBody = document.getElementById('epf-breakdown-table');
    tableBody.innerHTML = '';
    
    let cumulativeContribution = 0;
    let totalEPFAmount = yearlyData.length > 0 ? yearlyData[yearlyData.length - 1].balance : 0;
    
    // Show first 10 years, then show expandable section for remaining years
    const showInitially = Math.min(yearlyData.length, 10);
    
    yearlyData.forEach((data, index) => {
        const currentYear = new Date().getFullYear() + index;
        const totalPayment = data.contribution + data.interest;
        cumulativeContribution += data.contribution;
        const accumulatedPercentage = ((cumulativeContribution / totalEPFAmount) * 100).toFixed(2);
        
        const row = document.createElement('tr');
        
        // Add expandable row functionality - initially hide rows after 10th
        if (index >= showInitially) {
            row.style.display = 'none';
            row.classList.add('expandable-row');
        }
        
        // Row styling based on position
        row.className = `border-b border-gray-100 hover:bg-gray-50 transition-colors ${index >= showInitially ? 'expandable-row' : ''}`;
        
        row.innerHTML = `
            <td class="px-4 py-3 text-center font-medium text-gray-800 border-r border-gray-200">
                <span class="inline-flex items-center justify-center w-6 h-6 text-xs text-gray-600 bg-gray-100 rounded cursor-pointer hover:bg-gray-200" 
                      onclick="toggleRowDetails(this)" title="Click for details">âŠž</span>
                ${currentYear}
            </td>
            <td class="px-4 py-3 text-right font-medium text-gray-800 border-r border-gray-200">
                ${formatCurrency(data.contribution)}
            </td>
            <td class="px-4 py-3 text-right font-medium text-gray-800 border-r border-gray-200">
                ${formatCurrency(data.interest)}
            </td>
            <td class="px-4 py-3 text-right font-medium text-gray-800 border-r border-gray-200">
                ${formatCurrency(totalPayment)}
            </td>
            <td class="px-4 py-3 text-right font-bold text-gray-800 border-r border-gray-200">
                ${formatCurrency(data.balance)}
            </td>
            <td class="px-4 py-3 text-right text-gray-800">
                ${accumulatedPercentage}%
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Add expand/collapse button if there are more than 10 rows
    if (yearlyData.length > showInitially) {
        const expandRow = document.createElement('tr');
        expandRow.className = 'bg-gray-50 hover:bg-gray-100 cursor-pointer';
        expandRow.id = 'expand-collapse-row';
        expandRow.innerHTML = `
            <td colspan="6" class="px-4 py-3 text-center text-blue-600 font-medium" onclick="toggleAllRows()">
                <span id="expand-text">âŠž Show ${yearlyData.length - showInitially} more years</span>
            </td>
        `;
        tableBody.appendChild(expandRow);
    }
}

// Toggle individual row details
function toggleRowDetails(element) {
    const icon = element;
    if (icon.textContent === 'âŠž') {
        icon.textContent = 'âŠŸ';
        icon.title = 'Click to collapse';
        // You can add more detailed row information here
    } else {
        icon.textContent = 'âŠž';
        icon.title = 'Click for details';
    }
}

// Toggle all expandable rows
function toggleAllRows() {
    const expandableRows = document.querySelectorAll('.expandable-row');
    const expandText = document.getElementById('expand-text');
    const isExpanded = expandText.textContent.includes('Hide');
    
    expandableRows.forEach(row => {
        if (isExpanded) {
            row.style.display = 'none';
            expandText.innerHTML = `âŠž Show ${expandableRows.length} more years`;
        } else {
            row.style.display = 'table-row';
            expandText.innerHTML = `âŠŸ Hide ${expandableRows.length} years`;
        }
    });
}

// Download PDF functionality
function downloadPDF() {
    // Get current EPF calculation data
    const monthlySalary = document.getElementById('monthly_salary').value;
    const interestRate = document.getElementById('interest_rate').value;
    const years = document.getElementById('years_to_retirement').value;
    const finalAmount = document.getElementById('final-epf-amount').textContent;
    const totalInterest = document.getElementById('total-interest').textContent;
    const totalPayment = document.getElementById('total-payment').textContent;
    
    // Create PDF content
    const pdfContent = `
        EPF Calculator Results
        =====================
        
        Input Parameters:
        - Monthly Salary: â‚¹${monthlySalary}
        - Interest Rate: ${interestRate}%
        - Years to Retirement: ${years}
        
        Results:
        - Final EPF Amount: ${finalAmount}
        - Total Interest: ${totalInterest}
        - Total Payment: ${totalPayment}
        
        Generated on: ${new Date().toLocaleDateString()}
        Website: ${window.location.host}
    `;
    
    // Simple PDF download using data URL
    const blob = new Blob([pdfContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'EPF_Calculation_' + new Date().toISOString().split('T')[0] + '.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Show success message
    showNotification('PDF downloaded successfully!', 'success');
}

// Download Excel functionality
function downloadExcel() {
    // Get table data
    const table = document.getElementById('epf-breakdown-table');
    const rows = table.querySelectorAll('tr:not(.expandable-row):not(#expand-collapse-row)');
    
    let csvContent = 'Year,Principal (A),Interest (B),Total Payment (A + B),Balance,EPF Accumulated %\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 6) {
            const rowData = Array.from(cells).map(cell => {
                // Clean cell content - remove currency symbols and formatting
                let content = cell.textContent.trim();
                // Extract year from first cell (remove the toggle button)
                if (cells[0] === cell) {
                    content = content.replace(/[âŠžâŠŸ]/g, '').trim();
                }
                // Remove currency symbols for CSV
                content = content.replace(/â‚¹|,/g, '');
                return content;
            }).join(',');
            csvContent += rowData + '\n';
        }
    });
    
    // Create and download CSV file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'EPF_Calculation_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Show success message
    showNotification('Excel file downloaded successfully!', 'success');
}

// Share calculation functionality
function shareCalculation() {
    // Get current parameter values
    const params = {
        salary: document.getElementById('monthly_salary').value,
        rate: document.getElementById('interest_rate').value,
        years: document.getElementById('years_to_retirement').value,
        increase: document.getElementById('annual_increase').value,
        contribution: document.getElementById('epf_contribution_rate').value
    };
    
    // Create shareable URL with parameters
    const baseUrl = window.location.origin + window.location.pathname;
    const shareUrl = `${baseUrl}?salary=${params.salary}&rate=${params.rate}&years=${params.years}&increase=${params.increase}&contribution=${params.contribution}`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(shareUrl).then(() => {
        showNotification('Shareable link copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = shareUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Shareable link copied to clipboard!', 'success');
    });
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Load parameters from URL on page load
function loadParametersFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.has('salary')) {
        document.getElementById('monthly_salary').value = urlParams.get('salary');
        document.getElementById('monthly_salary_input').value = urlParams.get('salary');
    }
    if (urlParams.has('rate')) {
        document.getElementById('interest_rate').value = urlParams.get('rate');
        document.getElementById('interest_rate_input').value = urlParams.get('rate');
    }
    if (urlParams.has('years')) {
        document.getElementById('years_to_retirement').value = urlParams.get('years');
        document.getElementById('years_input').value = urlParams.get('years');
    }
    if (urlParams.has('increase')) {
        document.getElementById('annual_increase').value = urlParams.get('increase');
    }
    if (urlParams.has('contribution')) {
        document.getElementById('epf_contribution_rate').value = urlParams.get('contribution');
    }
}

// Sync all inputs
function syncInputs() {
    // Monthly Salary
    const monthlySalary = document.getElementById('monthly_salary');
    const monthlySalaryInput = document.getElementById('monthly_salary_input');
    
    monthlySalary.addEventListener('input', function() {
        monthlySalaryInput.value = this.value;
        updateSliderProgress(this);
        calculateEPF();
    });
    
    monthlySalaryInput.addEventListener('input', function() {
        monthlySalary.value = this.value;
        updateSliderProgress(monthlySalary);
        calculateEPF();
    });
    
    // Interest Rate
    const interestRate = document.getElementById('interest_rate');
    const interestRateInput = document.getElementById('interest_rate_input');
    
    interestRate.addEventListener('input', function() {
        interestRateInput.value = this.value;
        updateSliderProgress(this);
        calculateEPF();
    });
    
    interestRateInput.addEventListener('input', function() {
        interestRate.value = this.value;
        updateSliderProgress(interestRate);
        calculateEPF();
    });
    
    // Years to Retirement
    const yearsSlider = document.getElementById('years_to_retirement');
    const yearsInput = document.getElementById('years_input');
    
    yearsSlider.addEventListener('input', function() {
        yearsInput.value = this.value;
        updateSliderProgress(this);
        calculateEPF();
    });
    
    yearsInput.addEventListener('input', function() {
        yearsSlider.value = this.value;
        updateSliderProgress(yearsSlider);
        calculateEPF();
    });
    
    // Other inputs
    ['annual_increase', 'epf_contribution_rate'].forEach(id => {
        document.getElementById(id).addEventListener('input', calculateEPF);
    });
}

// Setup tenure toggle
function setupTenureToggle() {
    const yrBtn = document.getElementById('tenure-yr-btn');
    const moBtn = document.getElementById('tenure-mo-btn');
    const slider = document.getElementById('years_to_retirement');
    const input = document.getElementById('years_input');
    const unit = document.getElementById('years_unit');
    const labels = document.getElementById('years_labels');
    
    yrBtn.addEventListener('click', function() {
        if (isMonthMode) {
            // Convert months to years
            const currentValue = parseInt(slider.value);
            const yearValue = Math.round(currentValue / 12);
            
            slider.min = "5";
            slider.max = "40";
            slider.value = yearValue;
            input.value = yearValue;
            unit.textContent = "Yr";
            
            labels.innerHTML = `
                <span>5</span>
                <span>15</span>
                <span>25</span>
                <span>35</span>
                <span>40</span>
            `;
            
            updateSliderProgress(slider);
            isMonthMode = false;
        }
        
        yrBtn.classList.add('active');
        moBtn.classList.remove('active');
        calculateEPF();
    });
    
    moBtn.addEventListener('click', function() {
        if (!isMonthMode) {
            // Convert years to months
            const currentValue = parseInt(slider.value);
            const monthValue = currentValue * 12;
            
            slider.min = "60";  // 5 years
            slider.max = "480"; // 40 years
            slider.value = monthValue;
            input.value = monthValue;
            unit.textContent = "Mo";
            
            labels.innerHTML = `
                <span>60</span>
                <span>180</span>
                <span>300</span>
                <span>420</span>
                <span>480</span>
            `;
            
            updateSliderProgress(slider);
            isMonthMode = true;
        }
        
        moBtn.classList.add('active');
        yrBtn.classList.remove('active');
        calculateEPF();
    });
}

// Update slider progress color for Chrome/Opera
function updateSliderProgress(slider) {
    const min = parseFloat(slider.min);
    const max = parseFloat(slider.max);
    const val = parseFloat(slider.value);
    const percentage = ((val - min) / (max - min)) * 100;
    
    // For WebKit browsers (Chrome, Safari, Opera)
    const isWebKit = /webkit/i.test(navigator.userAgent);
    if (isWebKit) {
        slider.style.background = `linear-gradient(to right, #f97316 0%, #f97316 ${percentage}%, #e5e7eb ${percentage}%, #e5e7eb 100%)`;
    }
}

// Update all sliders on load and input
function updateAllSliders() {
    const sliders = document.querySelectorAll('.slider-orange');
    sliders.forEach(slider => {
        updateSliderProgress(slider);
        
        slider.addEventListener('input', function() {
            updateSliderProgress(this);
        });
    });
}

// Download PDF functionality
function downloadPDF() {
    const monthlySalary = document.getElementById('monthly_salary').value;
    const interestRate = document.getElementById('interest_rate').value;
    const years = document.getElementById('years_to_retirement').value;
    const finalAmount = document.getElementById('final-epf-amount').textContent;
    const totalInterest = document.getElementById('total-interest').textContent;
    const totalPayment = document.getElementById('total-payment').textContent;
    
    const pdfContent = `EPF Calculator Results\n=====================\n\nInput Parameters:\n- Monthly Salary: â‚¹${monthlySalary}\n- Interest Rate: ${interestRate}%\n- Years to Retirement: ${years}\n\nResults:\n- Final EPF Amount: ${finalAmount}\n- Total Interest: ${totalInterest}\n- Total Payment: ${totalPayment}\n\nGenerated on: ${new Date().toLocaleDateString()}\nWebsite: ${window.location.host}`;
    
    const blob = new Blob([pdfContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'EPF_Calculation_' + new Date().toISOString().split('T')[0] + '.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification('PDF downloaded successfully!', 'success');
}

// Download Excel functionality
function downloadExcel() {
    const table = document.getElementById('epf-breakdown-table');
    const rows = table.querySelectorAll('tr');
    
    let csvContent = 'Year,Principal (A),Interest (B),Total Payment (A + B),Balance,EPF Accumulated %\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 6) {
            const rowData = Array.from(cells).map(cell => {
                let content = cell.textContent.trim();
                content = content.replace(/[âŠžâŠŸ]/g, '').replace(/â‚¹|,/g, '');
                return content;
            }).join(',');
            csvContent += rowData + '\n';
        }
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'EPF_Calculation_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification('Excel file downloaded successfully!', 'success');
}

// Share calculation functionality
function shareCalculation() {
    const params = {
        salary: document.getElementById('monthly_salary').value,
        rate: document.getElementById('interest_rate').value,
        years: document.getElementById('years_to_retirement').value,
        increase: document.getElementById('annual_increase').value,
        contribution: document.getElementById('epf_contribution_rate').value
    };
    
    const baseUrl = window.location.origin + window.location.pathname;
    const shareUrl = `${baseUrl}?salary=${params.salary}&rate=${params.rate}&years=${params.years}&increase=${params.increase}&contribution=${params.contribution}`;
    
    navigator.clipboard.writeText(shareUrl).then(() => {
        showNotification('Shareable link copied to clipboard!', 'success');
    }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = shareUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Shareable link copied to clipboard!', 'success');
    });
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Toggle row details
function toggleRowDetails(element) {
    const icon = element;
    if (icon.textContent === 'âŠž') {
        icon.textContent = 'âŠŸ';
        icon.title = 'Click to collapse';
    } else {
        icon.textContent = 'âŠž';
        icon.title = 'Click for details';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    syncInputs();
    setupTenureToggle();
    updateAllSliders(); // Add this to initialize slider progress
    calculateEPF();
    loadParametersFromUrl();
});
</script>
{% endblock %} 